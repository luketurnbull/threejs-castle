import { useAppStore } from "@/store";
import { ModeToggle } from "./ui/mode-toggle";
import { useEffect, useState, useRef } from "react";
import Button from "./ui/button";
import { gsap } from "gsap";
import { MorphSVGPlugin } from "gsap/MorphSVGPlugin";

// Register the MorphSVG plugin
gsap.registerPlugin(MorphSVGPlugin);

export default function ControlPanel() {
  const started = useAppStore((state) => state.started);

  if (started) {
    return (
      <>
        <ModeToggle />
        <AudioToggle />
      </>
    );
  }

  return <StartButton />;
}

function AudioToggle() {
  const audioEnabled = useAppStore((state) => state.audioEnabled);
  const toggleAudio = useAppStore((state) => state.toggleAudio);
  const pathOneRef = useRef<SVGPathElement>(null);
  const pathTwoRef = useRef<SVGPathElement>(null);
  const pathThreeRef = useRef<SVGPathElement>(null);

  useEffect(() => {
    if (pathOneRef.current && pathTwoRef.current && pathThreeRef.current) {
      if (audioEnabled) {
        // Morph to sound-on state
        gsap.to(pathOneRef.current, {
          morphSVG:
            "M33.8133 34.8667C33.0923 34.8667 32.4049 34.5648 31.923 34.0388C31.4635 33.5465 31.2206 32.896 31.2505 32.2155C31.2804 31.5369 31.5755 30.9101 32.0799 30.4508C34.3214 28.4 35.8083 23.9359 35.8681 19.0829C35.9353 13.9431 34.3999 9.10302 31.9566 6.75188C30.9405 5.77727 30.9143 4.16442 31.8931 3.15795C32.3862 2.65749 33.04 2.383 33.7386 2.383C34.4073 2.383 35.0424 2.63824 35.5244 3.10202C39.0361 6.47964 41.0833 12.4766 40.9974 19.144C40.9189 25.5173 38.8829 31.1435 35.5505 34.1925C35.0723 34.6278 34.4559 34.8667 33.8133 34.8667ZM12.4292 29.0794V30.3556H0V9.24974H12.4292V10.6418L27.0589 0V8.7226C27.1187 8.63369 27.1822 8.54738 27.2531 8.46478C27.7351 7.89764 28.4486 7.56832 29.207 7.56832C29.8122 7.56832 30.4025 7.78206 30.8657 8.17027C33.5369 10.4192 35.1844 14.4769 35.2703 19.0258C35.3525 23.5062 33.9105 27.5288 31.4149 29.7869C30.9517 30.2133 30.339 30.4519 29.6927 30.4519C28.9717 30.4519 28.2805 30.1507 27.7948 29.6262C26.8422 28.586 26.9169 26.9753 27.9592 26.0326C29.3415 24.7831 30.197 22.0693 30.1447 19.1188C30.0849 16.1031 29.0688 13.3278 27.5483 12.0502C27.354 11.8865 27.1897 11.7002 27.0589 11.4986V39L12.4292 29.0794Z",
          duration: 0.4,
          ease: "power2.inOut",
        });
        gsap.to(pathTwoRef.current, {
          morphSVG:
            "M12.8663 27.8001L25.5533 36.4774V2.97301L12.8663 12.2809V27.8001ZM1.50928 29.108H10.9237V10.8344H1.50928V29.108ZM29.8907 9.38936C29.4461 9.01166 28.7774 9.06695 28.4 9.51376C28.019 9.95796 28.075 10.6244 28.5233 11.004C30.3838 12.5843 31.583 15.7452 31.6502 19.2543C31.7137 22.6943 30.6901 25.8017 28.9754 27.3674C28.542 27.7608 28.5159 28.4303 28.9081 28.8622C29.1136 29.0893 29.4013 29.2051 29.6927 29.2051C29.943 29.2051 30.2007 29.1136 30.4025 28.9279C32.5842 26.9367 33.8395 23.3051 33.7648 19.2162C33.6863 15.0537 32.2405 11.3817 29.8907 9.38936ZM34.4746 4.2092C37.6986 7.33313 39.5703 12.9709 39.4918 19.2879C39.4171 25.3124 37.5604 30.5788 34.5306 33.377C34.3251 33.5638 34.0711 33.6575 33.8133 33.6575C33.5257 33.6575 33.2417 33.5443 33.0363 33.3157C32.6403 32.8872 32.6627 32.2177 33.096 31.8206C35.6663 29.4472 37.3101 24.6339 37.3736 19.2636C37.4483 13.5989 35.7709 8.41354 33.0026 5.72857C32.5842 5.32099 32.573 4.65152 32.9765 4.23124C33.3874 3.80983 34.0562 3.80199 34.4746 4.2092Z",
          duration: 0.4,
          ease: "power2.inOut",
        });
        gsap.to(pathThreeRef.current, {
          morphSVG:
            "M12.8663 27.8001L25.5533 36.4774V2.97301L12.8663 12.2809V27.8001ZM1.50928 29.108H10.9237V10.8344H1.50928V29.108ZM29.8907 9.38936C29.4461 9.01166 28.7774 9.06695 28.4 9.51376C28.019 9.95796 28.075 10.6244 28.5233 11.004C30.3838 12.5843 31.583 15.7452 31.6502 19.2543C31.7137 22.6943 30.6901 25.8017 28.9754 27.3674C28.542 27.7608 28.5159 28.4303 28.9081 28.8622C29.1136 29.0893 29.4013 29.2051 29.6927 29.2051C29.943 29.2051 30.2007 29.1136 30.4025 28.9279C32.5842 26.9367 33.8395 23.3051 33.7648 19.2162C33.6863 15.0537 32.2405 11.3817 29.8907 9.38936ZM34.4746 4.2092C37.6986 7.33313 39.5703 12.9709 39.4918 19.2879C39.4171 25.3124 37.5604 30.5788 34.5306 33.377C34.3251 33.5638 34.0711 33.6575 33.8133 33.6575C33.5257 33.6575 33.2417 33.5443 33.0363 33.3157C32.6403 32.8872 32.6627 32.2177 33.096 31.8206C35.6663 29.4472 37.3101 24.6339 37.3736 19.2636C37.4483 13.5989 35.7709 8.41354 33.0026 5.72857C32.5842 5.32099 32.573 4.65152 32.9765 4.23124C33.3874 3.80983 34.0562 3.80199 34.4746 4.2092Z",
          duration: 0.4,
          ease: "power2.inOut",
        });
      } else {
        // Morph to sound-off state
        gsap.to(pathOneRef.current, {
          morphSVG:
            "M43.0489 28.8409C42.26 28.8409 41.5157 28.5338 40.9575 27.976L37.0315 24.0523L33.1054 27.976C32.5472 28.5338 31.8067 28.8409 31.0177 28.8409C30.2288 28.8409 29.4883 28.5338 28.93 27.9764C27.7764 26.8251 27.7764 24.9529 28.93 23.8028L32.8561 19.8786L28.9263 15.9545C27.7764 14.8062 27.7764 12.9332 28.9263 11.7809C29.4845 11.2223 30.2288 10.9156 31.0177 10.9156C31.8067 10.9156 32.5472 11.2227 33.1054 11.7801L37.0315 15.705L40.9575 11.7798C41.5157 11.222 42.26 10.9152 43.0489 10.9152C43.8379 10.9152 44.5785 11.2227 45.1367 11.7809C45.6949 12.3371 46 13.0786 46 13.8673C46 14.6556 45.6949 15.3975 45.1367 15.9549L41.2106 19.8786L45.1367 23.8028C45.6949 24.3602 46 25.102 46 25.8914C46 26.6801 45.6911 27.4208 45.1329 27.9775C44.5784 28.5334 43.8379 28.8409 43.0489 28.8409ZM12.381 29.1901V30.4715H0V9.28465H12.381V10.6824L26.9503 -1.2964e-05V39.1489L12.381 29.1901Z",
          duration: 0.4,
          ease: "power2.inOut",
        });
        gsap.to(pathTwoRef.current, {
          morphSVG:
            "M44.0417 12.8396C43.4728 12.2725 42.5543 12.2725 41.9854 12.8396L37.0026 17.825L32.0198 12.8396C31.4509 12.2725 30.5325 12.2737 29.9673 12.8396C29.3983 13.4074 29.3983 14.3274 29.9673 14.8948L34.95 19.8787L29.9673 24.8626C29.3983 25.43 29.3983 26.3488 29.9673 26.9163C30.5325 27.4837 31.4509 27.4837 32.0198 26.9163L37.0026 21.9324L41.9854 26.9163C42.5543 27.4837 43.4728 27.4837 44.0417 26.9163C44.6069 26.35 44.6069 25.43 44.0417 24.8626L39.059 19.8787L44.0417 14.8948C44.6069 14.3274 44.6069 13.4074 44.0417 12.8396ZM12.8027 27.6708L25.4307 36.3077V2.95924L12.8027 12.2234V27.6708ZM1.49855 10.7837H10.8729V28.9722H1.49855V10.7837Z",
          duration: 0.4,
          ease: "power2.inOut",
        });
        gsap.to(pathThreeRef.current, {
          morphSVG:
            "M44.0417 12.8396C43.4728 12.2725 42.5543 12.2725 41.9854 12.8396L37.0026 17.825L32.0198 12.8396C31.4509 12.2725 30.5325 12.2737 29.9673 12.8396C29.3983 13.4074 29.3983 14.3274 29.9673 14.8948L34.95 19.8787L29.9673 24.8626C29.3983 25.43 29.3983 26.3488 29.9673 26.9163C30.5325 27.4837 31.4509 27.4837 32.0198 26.9163L37.0026 21.9324L41.9854 26.9163C42.5543 27.4837 43.4728 27.4837 44.0417 26.9163C44.6069 26.35 44.6069 25.43 44.0417 24.8626L39.059 19.8787L44.0417 14.8948C44.6069 14.3274 44.6069 13.4074 44.0417 12.8396ZM12.8027 27.6708L25.4307 36.3077V2.95924L12.8027 12.2234V27.6708ZM1.49855 10.7837H10.8729V28.9722H1.49855V10.7837Z",
          duration: 0.4,
          ease: "power2.inOut",
        });
      }
    }
  }, [audioEnabled]);

  return (
    <Button
      onClick={toggleAudio}
      style={{
        width: "50px",
        height: "50px",
        position: "fixed",
        top: "20px",
        left: "20px",
      }}
      childrenStyle={{
        top: "53%",
        left: "55%",
      }}
    >
      <svg
        width="23"
        height="20"
        viewBox="0 0 46 40"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        {/* Path One - Background speaker cone */}
        <path
          ref={pathOneRef}
          d="M43.0489 28.8409C42.26 28.8409 41.5157 28.5338 40.9575 27.976L37.0315 24.0523L33.1054 27.976C32.5472 28.5338 31.8067 28.8409 31.0177 28.8409C30.2288 28.8409 29.4883 28.5338 28.93 27.9764C27.7764 26.8251 27.7764 24.9529 28.93 23.8028L32.8561 19.8786L28.9263 15.9545C27.7764 14.8062 27.7764 12.9332 28.9263 11.7809C29.4845 11.2223 30.2288 10.9156 31.0177 10.9156C31.8067 10.9156 32.5472 11.2227 33.1054 11.7801L37.0315 15.705L40.9575 11.7798C41.5157 11.222 42.26 10.9152 43.0489 10.9152C43.8379 10.9152 44.5785 11.2227 45.1367 11.7809C45.6949 12.3371 46 13.0786 46 13.8673C46 14.6556 45.6949 15.3975 45.1367 15.9549L41.2106 19.8786L45.1367 23.8028C45.6949 24.3602 46 25.102 46 25.8914C46 26.6801 45.6911 27.4208 45.1329 27.9775C44.5784 28.5334 43.8379 28.8409 43.0489 28.8409ZM12.381 29.1901V30.4715H0V9.28465H12.381V10.6824L26.9503 -1.2964e-05V39.1489L12.381 29.1901Z"
          fill="#582D34"
        />

        {/* Mask for the morphable content */}
        <mask
          id="audioMask"
          style={{ maskType: "luminance" }}
          maskUnits="userSpaceOnUse"
          x="1"
          y="2"
          width="44"
          height="35"
        >
          {/* Path Two - Mask path */}
          <path
            ref={pathTwoRef}
            d="M44.0417 12.8396C43.4728 12.2725 42.5543 12.2725 41.9854 12.8396L37.0026 17.825L32.0198 12.8396C31.4509 12.2725 30.5325 12.2737 29.9673 12.8396C29.3983 13.4074 29.3983 14.3274 29.9673 14.8948L34.95 19.8787L29.9673 24.8626C29.3983 25.43 29.3983 26.3488 29.9673 26.9163C30.5325 27.4837 31.4509 27.4837 32.0198 26.9163L37.0026 21.9324L41.9854 26.9163C42.5543 27.4837 43.4728 27.4837 44.0417 26.9163C44.6069 26.35 44.6069 25.43 44.0417 24.8626L39.059 19.8787L44.0417 14.8948C44.6069 14.3274 44.6069 13.4074 44.0417 12.8396ZM12.8027 27.6708L25.4307 36.3077V2.95924L12.8027 12.2234V27.6708ZM1.49855 10.7837H10.8729V28.9722H1.49855V10.7837Z"
            fill="white"
          />
        </mask>

        <g mask="url(#audioMask)">
          {/* Path Three - Main content (sound waves/X mark) */}
          <path
            ref={pathThreeRef}
            d="M44.0417 12.8396C43.4728 12.2725 42.5543 12.2725 41.9854 12.8396L37.0026 17.825L32.0198 12.8396C31.4509 12.2725 30.5325 12.2737 29.9673 12.8396C29.3983 13.4074 29.3983 14.3274 29.9673 14.8948L34.95 19.8787L29.9673 24.8626C29.3983 25.43 29.3983 26.3488 29.9673 26.9163C30.5325 27.4837 31.4509 27.4837 32.0198 26.9163L37.0026 21.9324L41.9854 26.9163C42.5543 27.4837 43.4728 27.4837 44.0417 26.9163C44.6069 26.35 44.6069 25.43 44.0417 24.8626L39.059 19.8787L44.0417 14.8948C44.6069 14.3274 44.6069 13.4074 44.0417 12.8396ZM12.8027 27.6708L25.4307 36.3077V2.95924L12.8027 12.2234V27.6708ZM1.49855 10.7837H10.8729V28.9722H1.49855V10.7837Z"
            fill="url(#audioGradient)"
          />
        </g>

        <defs>
          <linearGradient
            id="audioGradient"
            x1="22.9802"
            y1="2.95886"
            x2="22.9802"
            y2="36.3075"
            gradientUnits="userSpaceOnUse"
          >
            <stop stopColor="white" />
            <stop offset="0.409836" stopColor="#928384" />
            <stop offset="1" stopColor="#846E77" />
          </linearGradient>
        </defs>
      </svg>
    </Button>
  );
}

function StartButton() {
  const loadingState = useAppStore((state) => state.loadingState);
  const audioLoaded = useAppStore((state) => state.audioLoaded);
  const start = useAppStore((state) => state.start);
  const [showStartButton, setShowStartButton] = useState(false);

  useEffect(() => {
    if (loadingState === "daytime-audio-loaded" && audioLoaded) {
      setShowStartButton(true);
    }
  }, [loadingState, audioLoaded]);

  return (
    <div
      style={{
        position: "fixed",
        bottom: "5%",
        left: "50%",
        transform: "translate(-50%, -50%)",
        zIndex: 50,
      }}
    >
      <Button
        onClick={() => {
          start();
        }}
        style={{
          width: "100px",
          height: "100px",
          opacity: showStartButton ? 1 : 0,
          transform: showStartButton
            ? "scale(1) translateY(0)"
            : "scale(0.95) translateY(16px)",
        }}
        childrenStyle={{
          top: "52%",
          left: "57%",
        }}
      >
        <svg
          width="46"
          height="52"
          viewBox="0 0 46 52"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M3.55096 52C1.59307 52 0 50.4074 0 48.4485V3.55146C0 1.59255 1.59307 3.8743e-07 3.55096 3.8743e-07C4.16865 3.8743e-07 4.78175 0.162789 5.32262 0.478248L44.2076 22.9268C45.3183 23.5628 45.9818 24.7127 45.9818 25.9949C45.9818 27.2822 45.3188 28.427 44.2076 29.0732L5.32311 51.5217C4.78174 51.8372 4.16916 52 3.55096 52Z"
            fill="#664A49"
          />
          <mask
            id="mask0_8_12"
            style={{ maskType: "luminance" }}
            maskUnits="userSpaceOnUse"
            x="2"
            y="2"
            width="42"
            height="48"
          >
            <path
              d="M43.1819 24.7027L4.29743 2.25417C3.29915 1.67413 2.05103 2.39664 2.05103 3.55163V48.4487C2.05103 49.6037 3.29915 50.3211 4.29743 49.7462L43.1824 27.2925C44.1807 26.7176 44.1802 25.2777 43.1819 24.7027Z"
              fill="white"
            />
          </mask>
          <g mask="url(#mask0_8_12)">
            <path
              d="M43.1819 24.7027L4.29743 2.25417C3.29915 1.67413 2.05103 2.39664 2.05103 3.55163V48.4487C2.05103 49.6037 3.29915 50.3211 4.29743 49.7462L43.1824 27.2925C44.1807 26.7176 44.1802 25.2777 43.1819 24.7027Z"
              fill="url(#paint0_linear_8_12)"
            />
          </g>
          <defs>
            <linearGradient
              id="paint0_linear_8_12"
              x1="22.991"
              y1="2.05065"
              x2="22.991"
              y2="49.9502"
              gradientUnits="userSpaceOnUse"
            >
              <stop stopColor="white" />
              <stop offset="0.409836" stopColor="#928384" />
              <stop offset="1" stopColor="#846E77" />
            </linearGradient>
          </defs>
        </svg>
      </Button>
    </div>
  );
}
